{
  "blocking": [
    {
      "issue": "Pre-existing test failures in cli-detect.test.ts (5 failing) and peer-review.test.ts (16 failing) due to incomplete mocking of fs.existsSync. These should be fixed before implementing features that depend on CLI detection or peer review functionality.",
      "addedBy": "US-002",
      "addedAt": "2026-01-10T22:00:00Z"
    }
  ],
  "suggestions": [],
  "lessonsLearned": [
    {
      "lesson": "Check existing code before implementing - types for spec review were already added during US-013 (codebase context) since the CodebaseContext type was needed there",
      "category": "patterns",
      "addedBy": "US-001",
      "addedAt": "2026-01-10T12:00:00Z"
    },
    {
      "lesson": "When mocking fs module in vitest, ensure all synchronous functions (existsSync, etc.) are properly included in the mock using importOriginal helper pattern",
      "category": "testing",
      "addedBy": "US-002",
      "addedAt": "2026-01-10T22:00:00Z"
    },
    {
      "lesson": "For file-based tests that need to control paths like process.cwd(), use vi.spyOn(process, 'cwd').mockReturnValue(testDir) with real temp directories rather than mocking fs entirely - this allows testing actual file I/O behavior",
      "category": "testing",
      "addedBy": "US-003",
      "addedAt": "2026-01-10T22:10:00Z"
    },
    {
      "lesson": "For testing environment variable priority logic, store originalEnv = process.env in beforeEach, delete specific vars, and restore with process.env = originalEnv in afterEach. This avoids polluting test isolation.",
      "category": "testing",
      "addedBy": "US-005",
      "addedAt": "2026-01-10T22:15:00Z"
    },
    {
      "lesson": "Extract repeated inline conditional checks (like directory exclusion lists) into constants using Set for O(1) lookup performance and better maintainability - e.g., EXCLUDED_DIRECTORIES constant for listSourceDirectories",
      "category": "patterns",
      "addedBy": "US-008",
      "addedAt": "2026-01-10T22:25:00Z"
    },
    {
      "lesson": "For detecting multiple independent patterns in text (e.g., personas, boundaries), use separate regex pattern arrays iterated with Set<string> for deduplication - this separates concerns and makes threshold adjustments easy",
      "category": "patterns",
      "addedBy": "US-009",
      "addedAt": "2026-01-10T22:28:00Z"
    },
    {
      "lesson": "When converting text to kebab-case for filenames, filter stop words (the, a, an, of, for, to, in, on, with) and limit to 3 meaningful words for cleaner, more readable names",
      "category": "patterns",
      "addedBy": "US-010",
      "addedAt": "2026-01-10T22:37:00Z"
    },
    {
      "lesson": "Group related features by domain keywords (auth/login, user/profile, admin/dashboard, api/integration, notif/email) when proposing spec splits - this creates more cohesive split specs",
      "category": "architecture",
      "addedBy": "US-010",
      "addedAt": "2026-01-10T22:37:00Z"
    },
    {
      "lesson": "When building split file content from sections, use map().filter(Boolean) pattern instead of imperative loops - this is more idiomatic TypeScript and reads clearer (map sections to extracted content, filter empty)",
      "category": "patterns",
      "addedBy": "US-011",
      "addedAt": "2026-01-10T22:43:00Z"
    },
    {
      "lesson": "Test files should be co-located with the code they test (src/core/spec-review/__tests__/ not src/core/__tests__/) - follow the pattern established by other modules in the same directory",
      "category": "testing",
      "addedBy": "US-012",
      "addedAt": "2026-01-10T22:48:00Z"
    },
    {
      "lesson": "For testing sequential async operations with child processes, use vi.useFakeTimers() and vi.advanceTimersByTimeAsync() to control timing without real delays. Track spawned mock processes in an array to simulate sequential responses.",
      "category": "testing",
      "addedBy": "US-013",
      "addedAt": "2026-01-10T23:00:00Z"
    },
    {
      "lesson": "When spawning Claude CLI with full tool access, omit the --tools flag entirely (don't use --tools ''). The --tools '' flag explicitly disables tools.",
      "category": "architecture",
      "addedBy": "US-013",
      "addedAt": "2026-01-10T23:00:00Z"
    },
    {
      "lesson": "When extending existing functions with new behavior (like disableTools), prefer adding an options parameter object over creating duplicate functions. This keeps the API clean and allows future extensions.",
      "category": "patterns",
      "addedBy": "US-014",
      "addedAt": "2026-01-10T23:10:00Z"
    },
    {
      "lesson": "For decompose review (task validation against specs), the --tools '' flag is required to enable pure document comparison without the agent attempting to use file system tools.",
      "category": "architecture",
      "addedBy": "US-014",
      "addedAt": "2026-01-10T23:10:00Z"
    },
    {
      "lesson": "SuggestionCard type uses 'issue' and 'suggestedFix' fields for describing problems - don't assume 'title' and 'description' field names when displaying suggestions from spec review results.",
      "category": "gotchas",
      "addedBy": "US-015",
      "addedAt": "2026-01-10T23:20:00Z"
    },
    {
      "lesson": "When task specifies exact test names (e.g., 'specReview_WithValidFile_DelegatesToRunner'), keep them as specified even if code-simplifier suggests different naming. Task requirements take precedence over code style preferences.",
      "category": "testing",
      "addedBy": "US-016",
      "addedAt": "2026-01-10T23:25:00Z"
    },
    {
      "lesson": "Use @inquirer/prompts for interactive CLI menus - it provides ES module-compatible select() that works well with TypeScript and modern Node.js projects.",
      "category": "tooling",
      "addedBy": "US-017",
      "addedAt": "2026-01-10T23:30:00Z"
    },
    {
      "lesson": "Define directory search paths as a constant array (e.g., SPEC_SEARCH_DIRECTORIES) for easy maintenance and consistency. This makes it clear which directories are searched and in what order.",
      "category": "patterns",
      "addedBy": "US-017",
      "addedAt": "2026-01-10T23:30:00Z"
    },
    {
      "lesson": "Use onProgress callback pattern instead of verbose boolean flag when propagating progress through layers. The caller can decide what to do with messages (log to console, update UI, etc.) without the lower layer needing to know.",
      "category": "patterns",
      "addedBy": "US-018",
      "addedAt": "2026-01-10T23:35:00Z"
    },
    {
      "lesson": "When supporting multiple CLI types (claude, codex), rename hardcoded variable names (claudePath -> cliPath, claude -> cliProcess) to be generic. This makes the code clearer and avoids confusion when the actual CLI being used is determined dynamically.",
      "category": "patterns",
      "addedBy": "US-018",
      "addedAt": "2026-01-10T23:35:00Z"
    },
    {
      "lesson": "To test CLI console output, mock console.log with a closure that captures to an array, then join and search the array for expected content. Pattern: let logs = []; console.log = (...args) => logs.push(args.map(String).join(' ')); in beforeEach, restore original in afterEach.",
      "category": "testing",
      "addedBy": "US-019",
      "addedAt": "2026-01-10T23:40:00Z"
    },
    {
      "lesson": "Use @inquirer/prompts editor() function to allow users to edit structured data (like YAML proposals) in their default system editor. The function returns the edited content after the user saves and closes.",
      "category": "tooling",
      "addedBy": "US-020",
      "addedAt": "2026-01-10T23:48:00Z"
    },
    {
      "lesson": "For parsing user-edited YAML-like content, use regex with matchAll and spread operator for inline array construction: [...block.matchAll(/-\\s*\"([^\"]+)\"/g)].map((match) => match[1]). This is cleaner than imperative loops.",
      "category": "patterns",
      "addedBy": "US-020",
      "addedAt": "2026-01-10T23:48:00Z"
    },
    {
      "lesson": "When implementing cascading timeouts (SIGTERM then SIGKILL), use nested setTimeout in the initial timeout handler, and clear both timeouts in the process close/error handlers to prevent memory leaks and zombie timeouts.",
      "category": "patterns",
      "addedBy": "US-023",
      "addedAt": "2026-01-11T06:48:00Z"
    },
    {
      "lesson": "When tracking partial results in an iteration, break early on first failure/timeout - remaining iterations would likely fail too. This provides faster feedback to users while still returning useful partial data.",
      "category": "patterns",
      "addedBy": "US-023",
      "addedAt": "2026-01-11T06:48:00Z"
    },
    {
      "lesson": "Extract exit code logic into a named pure function (like getExitCodeForVerdict) for testability - this allows testing the logic without needing to mock process.exit. Simple ternary for binary exit codes is readable.",
      "category": "testing",
      "addedBy": "US-025",
      "addedAt": "2026-01-11T07:12:00Z"
    },
    {
      "lesson": "When passing dynamic values to functions that may read them multiple times, use getter function pattern (() => value) instead of capturing a static value. This allows callers to update the value mid-execution without needing callback mechanisms.",
      "category": "patterns",
      "addedBy": "US-027",
      "addedAt": "2026-01-11T07:25:00Z"
    },
    {
      "lesson": "When mocking runClaude for tests, the full RunResult interface requires parsed: { fullText: string, toolCalls: [], isComplete: boolean } - not the old block format. Create a helper function (createMockRunResult) to reduce boilerplate.",
      "category": "testing",
      "addedBy": "US-027",
      "addedAt": "2026-01-11T07:25:00Z"
    },
    {
      "lesson": "For Express route tests needing different project paths, use a module-level mockProjectPath variable that vi.mock can reference. Reset it in beforeEach. This avoids the limitation that mocks are hoisted and can't capture test-local variables.",
      "category": "testing",
      "addedBy": "US-028",
      "addedAt": "2026-01-11T07:36:00Z"
    },
    {
      "lesson": "detectGodSpec and generateSplitProposal functions require CodebaseContext as a parameter. For preview/quick checks, pass an empty context: { projectType: 'unknown', existingPatterns: [], relevantFiles: [] }",
      "category": "gotchas",
      "addedBy": "US-028",
      "addedAt": "2026-01-11T07:36:00Z"
    },
    {
      "lesson": "For converting file access checks to boolean, use Promise.then() with success/failure handlers: access(path).then(() => true, () => false). This is cleaner than try/catch with a mutable variable.",
      "category": "patterns",
      "addedBy": "US-029",
      "addedAt": "2026-01-11T07:44:00Z"
    },
    {
      "lesson": "When route parameters may contain paths (like spec file paths), URL encode them on the client side with encodeURIComponent() and decode on the server side with decodeURIComponent(req.params.paramName).",
      "category": "api",
      "addedBy": "US-029",
      "addedAt": "2026-01-11T07:44:00Z"
    },
    {
      "lesson": "When multiple endpoints need to find a session by ID, extract a helper function (findSessionById) to centralize the logic. This makes the code easier to maintain and ensures consistent error handling.",
      "category": "patterns",
      "addedBy": "US-030",
      "addedAt": "2026-01-11T07:52:00Z"
    },
    {
      "lesson": "When reverting multiple changes to restore original content, process changes in reverse chronological order. Each change stores beforeContent and afterContent, so reverting in reverse order ensures each step restores the correct intermediate state.",
      "category": "patterns",
      "addedBy": "US-031",
      "addedAt": "2026-01-11T07:56:00Z"
    },
    {
      "lesson": "For counting occurrences in a loop with an early-return threshold, combine counting and threshold check in a single pass with early return. Instead of counting everything then iterating the map again, return true as soon as the threshold is met.",
      "category": "patterns",
      "addedBy": "US-032",
      "addedAt": "2026-01-11T08:02:00Z"
    },
    {
      "lesson": "For resizable split panels in React without a library, use mousedown on a divider element + document-level mousemove/mouseup event listeners. Clean up listeners in useEffect return. Clamp width between 20-80% to prevent panel collapse.",
      "category": "patterns",
      "addedBy": "US-033",
      "addedAt": "2026-01-11T08:30:00Z"
    },
    {
      "lesson": "Use aria-orientation='vertical' and role='separator' on drag handles for accessible resizable panels. Also include aria-valuenow, aria-valuemin, and aria-valuemax for screen reader support.",
      "category": "architecture",
      "addedBy": "US-033",
      "addedAt": "2026-01-11T08:30:00Z"
    },
    {
      "lesson": "MDXEditor uses a plugin architecture where each capability is a separate plugin function. Call them to create RealmPlugin instances: headingsPlugin(), listsPlugin(), etc. The diffSourcePlugin provides viewMode option for rich-text/source/diff views.",
      "category": "tooling",
      "addedBy": "US-034",
      "addedAt": "2026-01-11T08:45:00Z"
    },
    {
      "lesson": "When wrapping third-party libraries like MDXEditor, use useImperativeHandle to expose a custom ref interface that wraps the underlying library's methods. This allows you to control what methods are exposed and add custom behavior.",
      "category": "patterns",
      "addedBy": "US-035",
      "addedAt": "2026-01-11T08:55:00Z"
    },
    {
      "lesson": "When testing React components that use complex third-party libraries, mock the entire library and provide a simplified implementation that exposes the same props interface. Use a simple textarea or div to simulate the actual component behavior.",
      "category": "testing",
      "addedBy": "US-035",
      "addedAt": "2026-01-11T08:55:00Z"
    }
  ]
}
